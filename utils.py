import pickle

import feather
import pandas as pd
from pandas_summary import DataFrameSummary


def create_or_load(train_path):
    """Reads dataset from a CSV file or previously saved binary formats."""

    temp_dir = train_path.parent / 'tmp'
    temp_dir.mkdir(parents=True, exist_ok=True)

    temp_data = temp_dir / 'data.feather'
    if temp_data.exists():
        print(f'Loading previously saved training data: {temp_data}')
        data = feather.read_dataframe(temp_data)
    else:
        print(f'Reading the CSV file with training data: {train_path}')
        data = pd.read_csv(train_path, low_memory=False)
        print(f'Saving data frame into feather file...')
        data.to_feather(temp_data)

    temp_summary = temp_dir / 'summary.pickle'
    if temp_summary.exists():
        print(f'Loading previously saved summary: {temp_summary}')
        state = pickle.load(temp_summary.open('rb'))
        summary = DataFrameSummary(pd.DataFrame())
        summary.__dict__.update(state)
    else:
        print('Generating summary statistics')
        summary = DataFrameSummary(data)
        print('Saving summary into pickle file...')
        with temp_summary.open('wb') as file:
            state = {'length': summary.length,
                     'columns_stats': summary.columns_stats,
                     'corr': summary.corr}
            pickle.dump(state, file)

    return data, summary
